# 3-Scenario Progression State Machine Logic Spec (Engineering)

## Purpose
Define the progression logic for three practice scenarios in the Assertive Communication activity using a mastery-gated, gamified flow.

Learners must achieve a minimum **overall score** threshold to unlock **Continue** to the next scenario. Scaffolding fades across scenarios via **suggested best answer availability**.

---

## Definitions

### Scenarios
- **S1:** Anna + Marcus
- **S2:** Maria + Anna
- **S3:** Scenario 3 (final)

### Thresholds (Unlock Continue)
- **S1:** `>= 75`
- **S2:** `>= 85`
- **S3:** `>= 90`

### Suggested Best Answer Policy
- **S1:** Available **after 1 failed attempt** (score below threshold)
- **S2:** Available **after 2 failed attempts**
- **S3:** **Not available**

### Scores
- `overallScore`: integer 0–100 returned by evaluation.
- `clearScores`: per-dimension 0–2 (Connect, Listen, Express, Align, Review) used for coaching.

### Attempts
- `attemptIndex`: integer starting at 1 per scenario (increments after each evaluation).
- `passed`: boolean (`overallScore >= threshold`).

---

## Data Model (Recommended)

### Persistent In-Session State
```ts
type ScenarioId = 'S1' | 'S2' | 'S3';

type ScenarioConfig = {
  id: ScenarioId;
  threshold: number;              // 75 / 85 / 90
  suggestedAnswerPolicy: {
    enabled: boolean;
    unlockAfterFailedAttempts: number; // S1=1, S2=2, S3=Infinity
  };
};

type AttemptResult = {
  attemptIndex: number;
  responseText: string;
  overallScore: number;
  clearScores: { connect: number; listen: number; express: number; align: number; review: number };
  coachingReportText: string; // already generated by evaluator
  practiceCue: { dimension: 'CONNECT'|'LISTEN'|'EXPRESS'|'ALIGN'|'REVIEW'; text: string };
  timestamp: number;
};

type ScenarioProgress = {
  scenarioId: ScenarioId;
  attemptIndex: number;           // next attempt number to be created
  bestScore: number;
  lastAttempt?: AttemptResult;
  attempts: AttemptResult[];
  continueUnlocked: boolean;      // derived from lastAttempt.passed
  suggestedAnswerUnlocked: boolean; // derived from failed attempts + policy
};

type ActivityProgress = {
  currentScenarioId: ScenarioId;
  scenarios: Record<ScenarioId, ScenarioProgress>;
  activityStatus: 'IN_PROGRESS'|'COMPLETED';
};
```

### Derived Helpers
- `failedAttempts = attempts.filter(a => a.overallScore < threshold).length`
- `suggestedAnswerUnlocked = enabled && failedAttempts >= unlockAfterFailedAttempts`
- `continueUnlocked = lastAttempt?.overallScore >= threshold`

---

## UI Rules (Engineering Constraints)

### Always Visible
- **Evaluate** button (submits current response)
- **Revise response** (practice loop) should always be available after at least one evaluation
- **Back** button (per existing navigation)

### Conditional Visibility
- **Continue** button:
  - Visible **only if** `continueUnlocked === true` for current scenario.
  - If not unlocked, the button is hidden/disabled per design preference, but the lock state must be communicated (see copy below).

- **Suggested best answer**:
  - S1 & S2 only, and visible **only if** `suggestedAnswerUnlocked === true`.
  - S3 never.

### Progress Messaging (Recommended)
- When below threshold, display: `You’re {threshold - overallScore} points away from unlocking the next scenario.`
  - Clamp at minimum 1.

---

## State Machine

### High-Level States
- `activity:init`
- `scenario:active` (S1/S2/S3)
- `scenario:evaluating`
- `scenario:feedback`
- `scenario:revise`
- `scenario:passed`
- `activity:completed`

### Events
- `START_ACTIVITY`
- `SUBMIT_EVALUATION`
- `EVALUATION_SUCCESS`
- `EVALUATION_ERROR`
- `CLICK_REVISE`
- `EDIT_RESPONSE`
- `CLICK_CONTINUE`
- `NEXT_SCENARIO`
- `FINISH_ACTIVITY`

---

## Transition Logic

### 1) Activity Start
**State:** `activity:init`
- On `START_ACTIVITY` → set `currentScenarioId = 'S1'` and enter `scenario:active`.

### 2) Scenario Active (Writing Mode)
**State:** `scenario:active`
- User writes response.
- On `SUBMIT_EVALUATION` → `scenario:evaluating`.

### 3) Evaluating
**State:** `scenario:evaluating`
- Call evaluator.
- On `EVALUATION_SUCCESS(payload)` →
  - Create `AttemptResult` (increment attempt index)
  - Update scenario progress:
    - `attempts.push(result)`
    - `lastAttempt = result`
    - `bestScore = max(bestScore, result.overallScore)`
    - `continueUnlocked = (result.overallScore >= threshold)`
    - `suggestedAnswerUnlocked` recomputed from failed attempts count
  - Go to `scenario:feedback`.
- On `EVALUATION_ERROR` → return to `scenario:active` and surface error.

### 4) Feedback
**State:** `scenario:feedback`
- Show in this order (recommended):
  1. Overall score
  2. CLEAR tiles
  3. CLEAR Coaching Report
  4. Practice cue
- Continue visibility:
  - If `continueUnlocked=true` show **Continue**.
  - Else hide/disable Continue and show “points away” message.
- Suggested answer:
  - If `suggestedAnswerUnlocked=true` show “Show suggested response”.

Transitions:
- On `CLICK_REVISE` → `scenario:revise`
- On `CLICK_CONTINUE` (guard: `continueUnlocked=true`) → `scenario:passed`

### 5) Revise
**State:** `scenario:revise`
- Prefill response with `lastAttempt.responseText`.
- Show practice focus hint (derived from lowest CLEAR score) above input.
- On `EDIT_RESPONSE` remain in `scenario:revise`.
- On `SUBMIT_EVALUATION` → `scenario:evaluating`.

### 6) Passed
**State:** `scenario:passed`
- Immediately transition based on scenario:
  - If `currentScenarioId === 'S1'` → `NEXT_SCENARIO` to `S2`
  - If `currentScenarioId === 'S2'` → `NEXT_SCENARIO` to `S3`
  - If `currentScenarioId === 'S3'` → `FINISH_ACTIVITY` to `activity:completed`

### 7) Next Scenario
**Event:** `NEXT_SCENARIO`
- Set `currentScenarioId = nextScenarioId`.
- Reset per-scenario UI (but keep stored progress).
- Enter `scenario:active`.

### 8) Completed
**State:** `activity:completed`
- Show completion screen.
- Optional: summary of best scores per scenario.

---

## Guards & Edge Cases

### Guard: Continue
- `CLICK_CONTINUE` must be ignored unless `continueUnlocked === true`.

### Edge: Perfect Score Early
- If learner passes threshold on first attempt, suggested answer may never unlock (expected).

### Edge: Many Attempts
- No hard cap required, but consider a soft guidance after N attempts (e.g., show suggested answer if eligible, emphasize practice cue).

### Edge: Missing Suggested Answer
- S3 must never display the suggested answer UI, even if failed attempts are high.

### Edge: Score Fluctuation
- Continue unlock depends on **last attempt** passing threshold. Once passed, you may either:
  - Keep Continue unlocked permanently for that scenario (recommended for less frustration), OR
  - Require the current attempt to pass.

**Recommendation:** once a scenario is passed, keep it passed (sticky pass). Implement by storing `scenarioPassed=true` and using it to show Continue.

---

## Copy Hooks (Engineering Placeholders)

### Scenario header rule
- `Unlock next scenario at: {threshold}%`

### Locked continue message
- `Next scenario locked — you’re {pointsAway} points away.`

### Suggested answer label
- `Show suggested response` (only when unlocked and permitted)

### Completion
- `You’ve completed all three scenarios. Nice work — you practiced without scaffolding in the final round.`

---

## Acceptance Criteria
- S1 Continue appears only after `overallScore >= 75`.
- S2 Continue appears only after `overallScore >= 85`.
- S3 Continue appears only after `overallScore >= 90`.
- Suggested answer availability:
  - S1 after 1 failed attempt
  - S2 after 2 failed attempts
  - S3 never
- Practice loop (revise) always available after evaluation.
- State transitions are deterministic and guard against skipping.

